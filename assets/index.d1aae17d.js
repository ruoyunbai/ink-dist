import{D as U,W as M,u as w,S as j,C as z,a as A,Y as B,_ as E,E as I}from"./MenuBar.c202bef8.js";import{_ as V,d as G,r as c,G as H,t as $,b as F,a as W,c as Y,u as K,v as P,f as d,S as Q,e as X,o as Z,g as N,h as y,i as m,l as _,j as k,p as ee,m as te,n as C,k as S,U as oe,F as q,q as J,x as b,H as ne}from"./index.18c8bd69.js";const ae=g=>(ee("data-v-aa03c46e"),g=g(),te(),g),se=ae(()=>S("br",null,null,-1)),re={key:0,class:"editor"},de={class:"editor__footer"},le=J(" offline "),ce={class:"editor__name"},ue=G({setup(g){c();const i=H();$(),F();const L=W(),u=Y();c([]),c([]),c(!1),c(-1),c(null),c(null),c(!0),c(!1),c(!1);const p=K(),l=P({id:-1,name:"room"}),x=c("connecting");let h=new U;i.$subscribe(()=>{if(i.Dopt=="word"){console.log("word"),i.Dopt="";let s=R();T(s)}if(i.Dopt=="load"){i.Dopt="";let s=i.DMname;O(s)}if(i.Dopt=="pdf"){console.log("pdf"),i.Dopt="";let s=R();D(s)}});const O=s=>{d({url:"http://127.0.0.1:3000/json/"+s+".json",method:"get",headers:{"Content-Type":"application/json"}}).then(function(t){var n;console.log("res",t),(n=e==null?void 0:e.value)==null||n.chain().clearContent().focus().toggleBold().setContent(t.data).run()})},T=s=>{d({url:d.defaults.baseURL+"/convert_html_to_docx",method:"post",headers:{"Content-Type":"application/json",Authorization:u.token},data:{content:s},transformRequest:[function(t,n){return JSON.stringify(t)}]}).then(function(t){var n;console.log("responseContent",t.data),window.open("https://inkbook.mina.moe/media/temp/"+t.data.url),(n=t.data)!=null&&n.success})},D=s=>{d({url:d.defaults.baseURL+"/convert_html_to_pdf",method:"post",headers:{"Content-Type":"application/json",Authorization:u.token},data:{content:s},transformRequest:[function(t,n){return JSON.stringify(t)}]}).then(function(t){var n;console.log("responseContent",t.data),window.open("https://inkbook.mina.moe/media/temp/"+t.data.url),(n=t.data)!=null&&n.success})},R=()=>e.value.getHTML();let f,e;if(console.log("params",p.params),p.params.id!=null){let s=function(t){var n,a;console.log("leave doc!!!!!!"),(n=e==null?void 0:e.value)==null||n.destroy(),f==null||f.destroy(),console.log("quit!"),l.id!=-1&&(d({url:d.defaults.baseURL+"/doc/quit_document",method:"post",headers:{"Content-Type":"application/json",Authorization:u.token},data:{document_id:l.id},transformRequest:[function(o,r){return JSON.stringify(o)}]}).then(function(o){var r;console.log("response",o),console.log(o.data),(r=o.data)!=null&&r.success}),d({url:d.defaults.baseURL+"/doc/upload_document",method:"post",headers:{"Content-Type":"application/json",Authorization:u.token},data:{content:JSON.stringify((a=e==null?void 0:e.value)==null?void 0:a.getJSON()),document_name:l.name,proj_id:1,document_id:l.id},transformRequest:[function(o,r){return JSON.stringify(o)}]}).then(function(o){var r;console.log("response",o),console.log(o.data),(r=o.data)!=null&&r.success}))};l.id=Number(p.params.id),l.name=String(p.params.name),f=new M("wss://demos.yjs.dev","gwx-"+String(L.id)+"-"+p.params.name,h),e=w({autofocus:!0,extensions:[j.configure({history:!1}),z.configure({document:h}),A.configure({provider:f,user:{name:u.Name,color:"#f783ac"}})],content:""}),setTimeout(()=>{console.log("lenth",e==null?void 0:e.value.storage.collaborationCursor.users.length),(e==null?void 0:e.value.storage.collaborationCursor.users.length)===1&&(console.log("you are first"),d({url:d.defaults.baseURL+"/doc/enter_document",method:"post",headers:{"Content-Type":"application/json",Authorization:u.token},data:{document_id:l.id},transformRequest:[function(t,n){return JSON.stringify(t)}]}).then(function(t){var n,a,o,r;console.log("responseContent",(n=t.data)==null?void 0:n.document.content),(a=t.data)!=null&&a.success&&((r=e==null?void 0:e.value)==null||r.chain().clearContent().focus().toggleBold().setContent(JSON.parse((o=t.data)==null?void 0:o.document.content)).run())}))},3e3),x.value="connected",window.addEventListener("beforeunload",s),Q(()=>{var t,n;window.removeEventListener("beforeunload",s),console.log("leave doc!!!!!!"),(t=e==null?void 0:e.value)==null||t.destroy(),f.destroy(),console.log("quit!","docid",l.id),l.id!=-1&&(d({url:d.defaults.baseURL+"/doc/quit_document",method:"post",headers:{"Content-Type":"application/json",Authorization:u.token},data:{document_id:l.id},transformRequest:[function(a,o){return JSON.stringify(a)}]}).then(function(a){var o;console.log("response",a),console.log(a.data),(o=a.data)!=null&&o.success}),d({url:d.defaults.baseURL+"/doc/upload_document",method:"post",headers:{"Content-Type":"application/json",Authorization:u.token},data:{content:JSON.stringify((n=e==null?void 0:e.value)==null?void 0:n.getJSON()),document_name:l.name,proj_id:1,document_id:l.id},transformRequest:[function(a,o){return JSON.stringify(a)}]}).then(function(a){var o;console.log("response",a),console.log(a.data),(o=a.data)!=null&&o.success}))})}else e=w({autofocus:!0,extensions:[j],content:""});return X(()=>{}),Z(()=>{}),console.log(h),console.log("ydoc",h.get("array",B)),(s,t)=>{const n=N("n-gi"),a=N("n-card"),o=N("n-grid");return C(),y("div",null,[m(E,{class:"editor__header",editor:_(e)},null,8,["editor"]),se,m(o,{cols:"100"},{default:k(()=>[m(n),m(n,{span:"99"},{default:k(()=>[m(a,{"content-style":`padding:0px;\r
          border-radius: 0.75rem;`},{default:k(()=>{var r,v;return[_(e)?(C(),y("div",re,[m(_(I),{class:"editor__content",editor:_(e)},null,8,["editor"]),S("div",de,[S("div",{class:oe(`editor__status editor__status--${x.value}`)},[x.value==="connected"?(C(),y(q,{key:0},[J(b((r=_(e))==null?void 0:r.storage.collaborationCursor.users.length)+" user"+b(((v=_(e))==null?void 0:v.storage.collaborationCursor.users.length)===1?"":"s")+" online in "+b(_(l).name),1)],64)):(C(),y(q,{key:1},[le],64))],2),S("div",ce,b(_(u).Name),1)])])):ne("",!0)]}),_:1})]),_:1})]),_:1})])}}});var fe=V(ue,[["__scopeId","data-v-aa03c46e"]]);export{fe as default};
